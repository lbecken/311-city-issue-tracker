<mat-card class="form-card">
  <mat-card-header>
    <mat-card-title>Report a Municipal Issue</mat-card-title>
    <mat-card-subtitle>Help us keep the city clean and safe</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="issueForm" (ngSubmit)="onSubmit()">
      <!-- Title Field -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Issue Title</mat-label>
        <input matInput formControlName="title" placeholder="e.g., Large pothole on Main St" />
        <mat-hint align="end">{{ f['title'].value?.length || 0 }}/200</mat-hint>
        <mat-error *ngIf="f['title'].hasError('required') && f['title'].touched">
          Title is required
        </mat-error>
        <mat-error *ngIf="f['title'].hasError('maxlength')"> Title must be under 200 characters </mat-error>
      </mat-form-field>

      <!-- Description Field -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea
          matInput
          formControlName="description"
          rows="4"
          placeholder="Provide details about the issue..."
        ></textarea>
        <mat-hint align="end">{{ f['description'].value?.length || 0 }}/2000</mat-hint>
        <mat-error *ngIf="f['description'].hasError('maxlength')"> Description is too long </mat-error>
      </mat-form-field>

      <!-- Category Dropdown -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Category</mat-label>
        <mat-select formControlName="category">
          <mat-option *ngFor="let cat of categories" [value]="cat.value">
            {{ cat.label }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="f['category'].hasError('required') && f['category'].touched">
          Please select a category
        </mat-error>
      </mat-form-field>

      <!-- Location Picker Map -->
      <div class="section-title">Location</div>
      <app-location-picker
        (locationSelected)="onLocationSelected($event)"
        (addressResolved)="onAddressResolved($event)"
      ></app-location-picker>

      <!-- Hidden location fields (populated by map) -->
      <div class="location-grid">
        <mat-form-field appearance="outline">
          <mat-label>Latitude</mat-label>
          <input matInput type="number" formControlName="latitude" readonly />
          <mat-error *ngIf="f['latitude'].hasError('required') && f['latitude'].touched">
            Click on the map to select location
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Longitude</mat-label>
          <input matInput type="number" formControlName="longitude" readonly />
          <mat-error *ngIf="f['longitude'].hasError('required') && f['longitude'].touched">
            Click on the map to select location
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Address Field (auto-filled from geocoding) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Address</mat-label>
        <input matInput formControlName="address" placeholder="Auto-filled from map selection" readonly />
      </mat-form-field>

      <!-- Image Upload -->
      <div class="section-title">Photos (Optional)</div>
      <app-image-upload (filesChanged)="onImagesChanged($event)"></app-image-upload>

      <!-- Reporter Info -->
      <div class="section-title">Your Information</div>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Your Name</mat-label>
        <input matInput formControlName="reportedBy" placeholder="John Doe" />
        <mat-error *ngIf="f['reportedBy'].hasError('required') && f['reportedBy'].touched">
          Your name is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Your Email</mat-label>
        <input matInput type="email" formControlName="reporterEmail" placeholder="john.doe@example.com" />
        <mat-error *ngIf="f['reporterEmail'].hasError('required') && f['reporterEmail'].touched">
          Email is required
        </mat-error>
        <mat-error *ngIf="f['reporterEmail'].hasError('email')"> Invalid email format </mat-error>
      </mat-form-field>

      <!-- Form Actions -->
      <div class="button-row">
        <button mat-raised-button color="primary" type="submit" [disabled]="issueForm.invalid || isSubmitting">
          <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
          <span *ngIf="!isSubmitting">Submit Issue</span>
          <span *ngIf="isSubmitting">Submitting...</span>
        </button>
        <button mat-button type="button" (click)="onReset()" [disabled]="isSubmitting">Clear Form</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
